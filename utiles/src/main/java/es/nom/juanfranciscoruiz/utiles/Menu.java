package es.nom.juanfranciscoruiz.utiles;

import es.nom.juanfranciscoruiz.utiles.exceptions.MenuException;
import es.nom.juanfranciscoruiz.utiles.exceptions.TypeConverterException;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.Scanner;

/**
 * It's the representation of an options menu, capable of generating a view of
 * this menu for output devices or streams and for obtaining the user's
 * response.
 *
 * TODO: Save the entire generated menu as a String using a method and delegate
 * its printing outside the class (to the IO class, for example, or the standard
 * Java API). Proceed in the same way with the user's option selection. Use the
 * IO class or a class from the standard Java API for the input itself.
 *
 * When you want to display the menu, assuming the Menu instance is called
 * principalMenu, it would look something like this:
 *
 * IO io = new IO(); io.prt(principalMenu.getMenuView());
 *
 * Translate it into English... :-/
 *
 * @author juanf
 */
public class Menu {

    /**
     * The list of options from menu.
     */
    private List<String> options;

    /**
     * The title of the menu
     */
    private String title;
    /**
     * A message that will appear below the menu options list and is usually
     * used to display messages to the user.
     */
    private String message;

    /**
     * It contains the option selected by the user
     */
    private Long selectedOption;

    /**
     * In the case that an application has several menus, if isHomeMenu is true,
     * then this is the main menu of the application and the option "0. Exit the
     * application" will be added as the first option.
     */
    private boolean isHomeMenu;

    /**
     * A complete String representation of the menu to be displayed on the
     * screen. Its value is generated by the generate() method, which constructs
     * its different parts from the other properties of the Menu object.
     */
    private String menuView;

    private static final String NOTITLE = "Untitled";
    private static final String EXITOPT = "0. Exit the application";
    private static final String DEFAULTMSG = "Make your selection:";
    private static final String ERR_BLANK_NULL = "You must enter a number with the option to choose.";
    private static final String ERR_NONUMBER = "What was entered is not a number.";
    private static final String ERR_NOTVALIDNUMBER = "You have not entered a valid number.";
    private static final String ERR_NUMBEROUTOFRANGE = "The selected option is outside the allowed range";
    private static final Long WRONGOPTION = -1L;

    /**
     * Instantiate a Menu object
     */
    public Menu() {
        this.options = new ArrayList<>();
        this.isHomeMenu = false;
        this.title = NOTITLE;
        this.message = "";
        this.menuView = "";
    }

    /**
     * Instantiate a Menu object with the specified parameters
     *
     * @param options A list of options
     * @param title A string with the menu title
     * @param message A string containing the message that will be displayed
     * below the list of options
     * @param isHomeMenu Boolean indicating whether it is the application's main
     * menu, which will add the option "0. Exit the application" to the options
     * property.
     */
    public Menu(List<String> options, String title, String message, 
            boolean isHomeMenu) {
        if (options != null && !options.isEmpty()) {
            this.options = options;
        } else {
            this.options = new ArrayList<>();
        }
        if (title != null && !title.isEmpty()) {
            this.title = title;
        } else {
            this.title = NOTITLE;
        }
        if (message != null && !message.isEmpty()) {
            this.message = message;
        } else {
            this.message = message;
        }

        this.isHomeMenu = isHomeMenu;
        if (this.isHomeMenu) {
            this.options.add(0, EXITOPT);
        }

    }

    /**
     * Gets the list of menu options
     *
     * @return A list of strings with the options.
     */
    public List<String> getOptions() {
        return options;
    }

    /**
     * Sets the menu options list
     *
     * @param options A list of strings with the new menu options.
     */
    public void setOptions(List<String> options) {
        this.options = options;
        if (this.isHomeMenu) {
            this.options.add(0, EXITOPT);
        }
    }

    /**
     * Gets the menu title
     *
     * @return a string with the menu title
     */
    public String getTitle() {
        return title;
    }

    /**
     * Set the menu title
     *
     * @param title A chain with the new menu title
     */
    public void setTitle(String title) {
        this.title = title;
    }

    /**
     * Gets the message from the menu
     *
     * @return a string with the current menu message
     */
    public String getMessage() {
        return message;
    }

    /**
     * Set a new message in the menu
     *
     * @param message A string with the new menu message
     */
    public void setMessage(String message) {
        this.message = message;
    }

    /**
     * Gets the option currently selected by the user (after calling the
     * awaitResponse() method).
     *
     * @return a long with the option selected by the user
     */
    public Long getSelectedOption() {
        return selectedOption;
    }

    /**
     * Set the selected option
     *
     * @param selectedOption A long file with the selected option
     */
    public void setSelectedOption(Long selectedOption) {
        this.selectedOption = selectedOption;
    }

    /**
     * Returns a boolean indicating whether this menu is the application's main
     * menu.
     *
     * @return a boolean, if true it indicates that the current menu is the main
     * menu of the application and false otherwise.
     */
    public boolean getIsHomeMenu() {
        return isHomeMenu;
    }

    /**
     * Sets the boolean value indicating whether the current menu is the main
     * menu. If 'true' is passed, the option "0. Exit the application" will be
     * added as the first option in the list of options.
     *
     * @param isHomeMenu boolean, if true it indicates that the current menu is
     * the main menu of the application and false otherwise.
     */
    public void setIsHomeMenu(boolean isHomeMenu) {
        //TODO: If set to false, you will need to check if it has the option
        // "0. Exit the application" and remove it.
        this.isHomeMenu = isHomeMenu;
        if (this.isHomeMenu) {
            this.options.add(0, EXITOPT);
        }
    }

    /**
     * Returns the string containing the contents of the menuView property
     * @return a string containing the menu content in text form
     */
    public String getMenuView() {
        return menuView;
    }

    /**
     * Sets the value of menuView as the value for the menuView property
     * 
     * @param menuView a string with the content to be set (although it can be 
     * any content, logically it should be the textual representation of a 
     * menu).
     */
    public void setMenuView(String menuView) {
        this.menuView = menuView;
    }

    /**
     * Generates a text representation in String format of the menu in its 
     * current state in the menuView attribute. This property can then be 
     * displayed to standard output or in a stream by another client class.
     */
    public void generateMenuView() {
        final String LS = System.lineSeparator();
        StringBuilder sb = new StringBuilder();
        StringBuilder sbMenuView = new StringBuilder();

        sb.append(LS);
        int longitud = this.getTitle().length();
        for (int i = 0; i < longitud + 5; i++) {
            sb.append("*");
        }

        sb.append(LS);
        sb.append("  ").append(this.getTitle()).append("  ");
        sb.append(LS);
        for (int i = 0; i < longitud + 5; i++) {
            sb.append("*");
        }

        String tit = sb.toString();
        sbMenuView
                .append(tit)
                .append(LS)
                .append(LS);

        for (String opcion : this.getOptions()) {
            sbMenuView.append(opcion).append(LS);
        }
        sbMenuView.append(LS);
        sbMenuView.append(this.getMessage());
        sbMenuView.append(LS);
        this.setMenuView(sbMenuView.toString());
    }

    /**
     * It awaits the user's response, setting their response in the 
     * <code>optionSelected</code> property as a long, or the value -1 if an error 
     * occurs. This method handles errors, throwing a MenuException in the 
     * following cases:
     * <ul>
     * <li>Entered value is not a number.</li>
     * <li>Entered value is a number, but outside the range of the options list.</li>
     * <li>Enter is pressed directly.</li>
     * </ul>
     * 
     * It also sets the 'message' field with the error message, so that the 
     * display() method can then display it on the screen.
     * 
     * @param msg An optional string with the text to be printed to the left of 
     * the user prompt. If nothing is specified, the phrase "Make your 
     * selection: " will be printed.
     * 
     * @throws es.nom.juanfranciscoruiz.utiles.exceptions.MenuException In case 
     * an error is detected.
     */
    public void awaitResponse(String msg) throws MenuException {
        var resp = WRONGOPTION;
        String respuesta = "";
        int opcMaxima = this.getOptions().size() - 1;

        if (msg == null || msg.isEmpty()) {
            msg = DEFAULTMSG;
        }

        System.out.println(msg);

        try (Scanner sc = new Scanner(new UnclosableInputStreamDecorator(System.in))) {
            respuesta = sc.nextLine();
        } catch (Exception ex) {
            throw new MenuException(ex.getMessage());
        }

        if (Types.isNullOrEmpty(respuesta)) {
            this.setMessage(ERR_BLANK_NULL);
            throw new MenuException(ERR_BLANK_NULL);
        }

        if (!Types.isInteger(respuesta)) {
            this.setMessage(ERR_NONUMBER);
            throw new MenuException(ERR_NONUMBER);
        }
        
        try {
            resp = TypeConverter.extractLongFromString(respuesta);
            if (Objects.equals(resp, WRONGOPTION)) {
                this.setMessage(ERR_NOTVALIDNUMBER);
                resp = WRONGOPTION;
            } else if (resp < 0 || resp > opcMaxima) {
                this.setMessage(ERR_NUMBEROUTOFRANGE);
                resp = WRONGOPTION;
            }
        } catch (TypeConverterException ex) {
            System.out.println(ex.getLocalizedMessage());
            resp = WRONGOPTION;
        }
        this.setSelectedOption(resp);
    }

    /**
     * This overrided toString() method don't show the menuView property because
     * this property is the result of rendering another properties of class with
     * generateMenuView() method.
     *
     * @return A string with a textual representation of this object
     */
    @Override
    public String toString() {
        StringBuilder sb = new StringBuilder();
        sb.append("Menu{");
        sb.append("opciones=").append(Util.CollectionToString(options, true, 10));
        sb.append(", titulo=").append(title);
        sb.append(", mensaje=").append(message);
        sb.append(", opcionSeleccionada=").append(selectedOption);
        sb.append(", esMenuInicio=").append(isHomeMenu);
        sb.append('}');
        return sb.toString();
    }
}